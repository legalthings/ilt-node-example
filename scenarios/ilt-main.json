{
    "$schema": "https://specs.livecontracts.io/v0.1.0/scenario/schema.json#",
    "id": "lt:/scenarios/edfbe857-9e0b-4db5-afe9-6bdf5dd1deb0",
    "title": "ILT main",
    "actors": {
        "ilt": {
            "title": "ILT (Dutch regulator)",
            "$ref": "https://specs.livecontracts.io/v0.1.0/actor/schema.json#role",
            "role": "authority"
        },
        "license_holder": {
            "title": "License holder",
            "$ref": "https://specs.livecontracts.io/v0.1.0/actor/schema.json#organization",
            "role": "license_holder"
        }
    },
    "assets": {
        "license": {
            "type": "object",
            "properties": {
                "reference": {
                    "description": "License No",
                    "type": "integer"
                },
                "shipments": {
                    "description": "Total number of shipments",
                    "type": "integer"
                },
                "quantity": {
                    "description": "Total qualtity",
                    "type": "float"
                },
                "period": {
                    "description": "Intended period",
                    "type": "object",
                    "properties": {
                        "from": {
                            "type": "string",
                            "format": "date"
                        },
                        "to": {
                            "type": "string",
                            "format": "date"
                        }
                    }
                }
            }
        },
        "available": {
            "description": "Available qualtities",
            "type": "object",
            "properties": {
                "shipments": {
                    "type": "integer"
                },
                "quantity": {
                    "type": "float"
                }
            }
        },
        "reserved": {
            "description": "Reserved qualtities",
            "type": "object",
            "properties": {
                "shipments": {
                    "type": "integer",
                    "default": 0
                },
                "quantity": {
                    "type": "float",
                    "default": 0.0
                }
            }
        },
        "spend": {
            "description": "Spend qualtities",
            "type": "object",
            "properties": {
                "shipments": {
                    "type": "integer",
                    "default": 0
                },
                "quantity": {
                    "type": "float",
                    "default": 0.0
                }
            }
        }
    },
    "definitions": {
    },
    "actions": {
        "issue": {
            "$schema": "http://specs.legalthings.one/v0.1.0/action/schema.json#data",
            "actor": "ilt",
            "responses": {
                "ok": {
                    "title": "Issued new license",
                    "update": [
                        {
                            "select": "assets.license",
                            "data": {
                                "<ref>": "response.data"
                            }
                        },
                        {
                            "select": "assets.available",
                            "data": {
                                "<ref>": "response.data"
                            }
                        },
                        {
                            "select": "actors.license_holder",
                            "data": { "<ref>": "response.data.license_holder" }
                        }
                    ]
                }
            }
        },
        "invite_holder": {
            "$schema": "http://specs.legalthings.one/v0.1.0/action/schema.json#event",
            "actor": "ilt",
            "body": {
                "$schema": "http://specs.legalthings.one/v0.1.0/identity/schema.json#",
                "id": "f53db508-9352-4280-822f-43b0e428cff6",
                "info": {
                    "name": {
                        "<ref>": "response.data.license_holder.name"
                    }
                },
                "signkeys": {
                    "user": { "<ref>": "response.data.license_holder.public_key" }
                }
            },
            "responses": {
                "ok": {
                    "display": "never",
                    "update": {
                        "select": "actors.license_holder",
                        "data": "denied"
                    }
                },
                "error": {
                    "display": "always",
                    "title": "Failed to add the license holder"
                }
            }
        },
        "verify_shipment": {
            "$schema": "http://specs.legalthings.one/v0.1.0/action/schema.json#data",
            "actor": "ilt",
            "responses": {
                "ok": {
                    "display": "never"
                }
            }
        },
        "verify_shipment_reserve": {
            "$schema": "http://specs.legalthings.one/v0.1.0/action/schema.json#nop",
            "actor": "ilt",
            "default_response": {
                "<if>": {
                    "condition": {
                        "<eval>": "assets.available.shipments > 0 && assets.available.quantity >= assets.new_shipment.quantity"
                    },
                    "then": "approve",
                    "else": "deny"
                }
            },
            "responses": {
                "approve": {
                    "display": "always",
                    "label": {
                        "<tpl>": "Shipment {{ assets.new_shipment.reference }} approved"
                    },
                    "update": [
                        {
                            "select": "assets.new_shipment.response",
                            "data": "continue"
                        },
                        {
                            "select": "assets.available",
                            "data": {
                                "<eval>": "{shipments: assets.available.shipments - `1`, quantity: assets.available.quantity - assets.new_shipment.quality}"
                            }
                        },
                        {
                            "select": "assets.reserved",
                            "data": {
                                "<eval>": "{shipments: assets.reserved.shipments + `1`, quantity: assets.reserved.quantity + assets.new_shipment.quality}"
                            }
                        }
                    ]
                },
                "deny": {
                    "display": "always",
                    "label": {
                        "<tpl>": "Shipment {{ assets.new_shipment.reference }} denied"
                    },
                    "update": {
                        "select": "assets.new_shipment.response",
                        "data": "cancel"
                    }
                }
            }
        },
        "verify_shipment_respond": {
            "$schema": "http://specs.legalthings.one/v0.1.0/action/schema.json#event",
            "actor": "ilt",
            "body": {
                "$schema": "http://specs.legalthings.one/v0.1.0/response/schema.json#",
                "process": {
                    "id": {
                        "<ref>": "assets.new_shipment.id"
                    }
                },
                "action": {
                    "key": "verify_process"
                },
                "key": {
                    "<ref>": "assets.new_shipment.response"
                },
                "data": {
                    "<ref>": "assets.new_shipment"
                }
            },
            "responses": {
                "ok": {
                    "title": "Cancelled process",
                    "display": "always"
                }
            }
        },
        "end_shipment": {
            "$schema": "http://specs.legalthings.one/v0.1.0/action/schema.json#data",
            "actor": "ilt",
            "responses": {
                "complete": {
                    "title": {
                        "<tpl>": "Completed process {{ response.data.reference }}"
                    },
                    "display": "always",
                    "update": [
                        {
                            "select": "assets.reserved",
                            "data": {
                                "<eval>": "{shipments: assets.reserved.shipments - `1`, quantity: assets.reserved.quantity - response.data.quantity}"
                            }
                        },
                        {
                            "select": "assets.spend",
                            "data": {
                                "<eval>": "{shipments: assets.spend.shipments + `1`, quantity: assets.reserved.quantity + response.data.quantity}"
                            }
                        }
                    ]
                },
                "cancel": {
                    "title": {
                        "<tpl>": "Cancelled process {{ response.data.reference }}"
                    },
                    "display": "always",
                    "update": [
                        {
                            "select": "assets.reserved",
                            "data": {
                                "<eval>": "{shipments: assets.reserved.shipments - `1`, quantity: assets.reserved.quantity - response.data.quality}"
                            }
                        },
                        {
                            "select": "assets.available",
                            "data": {
                                "<eval>": "{shipments: assets.available.shipments + `1`, quantity: assets.available.quantity + response.data.quality}"
                            }
                        }
                    ]
                }
            }
        }
    },
    "states": {
        ":initial": {
            "actions": [
                "issue"
            ],
            "transitions": [
                {
                    "action": "issue",
                    "transition": "live"
                }
            ]
        },
        "live": {
            "actions": [
                "verify_shipment",
                "end_shipment"
            ],
            "default_action": ":none",
            "transitions": [
                {
                    "action": "verify_shipment",
                    "transition": "verify_shipment_reserve"
                }
            ]
        },
        "verify_shipment_reserve": {
            "default_action": "verify_shipment_reserve",
            "transitions": [
                {
                    "action": "verify_shipment_reserve",
                    "transition": "verify_shipment_respond"
                }
            ]
        },
        "verify_shipment_respond": {
            "default_action": "verify_shipment_respond",
            "transitions": [
                {
                    "action": "verify_shipment_respond",
                    "transition": "live"
                }
            ]
        }
    }
}
